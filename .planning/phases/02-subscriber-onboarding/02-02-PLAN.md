---
phase: 02-subscriber-onboarding
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - app/onboarding/page.tsx
  - app/onboarding/layout.tsx
  - components/onboarding/stepper.tsx
  - components/onboarding/progress-bar.tsx
  - components/onboarding/step-topics.tsx
  - components/onboarding/topic-category-card.tsx
  - components/onboarding/step-format.tsx
autonomous: true
requirements: [SIGN-01, SIGN-02, SIGN-03, COPY-02]

must_haves:
  truths:
    - "Visitor navigating to /onboarding sees a multi-step form starting at the Topics step"
    - "Subscriber can select topic categories that expand to show subtopics, with '(Most Popular)' labels on popular categories"
    - "Subscriber can add freeform custom topics in a text area after category selection"
    - "Subscriber can choose newsletter format (digest, briefing, mixed) with identity-framed F/G/E descriptions and '(Most Popular)' on digest"
    - "Steps animate with direction-aware slide transitions (forward slides right-to-left, back slides left-to-right)"
    - "A progress indicator shows the subscriber which step they are on"
    - "All step headers and CTAs use F/G/E microcopy framework"
  artifacts:
    - path: "app/onboarding/page.tsx"
      provides: "Onboarding route page"
      min_lines: 10
    - path: "components/onboarding/stepper.tsx"
      provides: "Main stepper container with useReducer state machine and AnimatePresence transitions"
      contains: "useReducer"
    - path: "components/onboarding/step-topics.tsx"
      provides: "Topic selection step with expandable categories and custom topics textarea"
      contains: "TOPIC_CATEGORIES"
    - path: "components/onboarding/step-format.tsx"
      provides: "Format choice step with 3 format options"
      contains: "digest"
  key_links:
    - from: "app/onboarding/page.tsx"
      to: "components/onboarding/stepper.tsx"
      via: "imports and renders Stepper component"
      pattern: "import.*Stepper"
    - from: "components/onboarding/stepper.tsx"
      to: "components/onboarding/step-topics.tsx"
      via: "renders step component based on state.step"
      pattern: "step-topics|StepTopics"
    - from: "components/onboarding/step-topics.tsx"
      to: "lib/data/topics.ts"
      via: "imports TOPIC_CATEGORIES for rendering"
      pattern: "import.*TOPIC_CATEGORIES"
    - from: "components/onboarding/stepper.tsx"
      to: "lib/schemas/onboarding.ts"
      via: "types for form state"
      pattern: "import.*OnboardingData"
---

<objective>
Build the onboarding stepper shell (route, layout, container, progress bar, transitions) and the first two step components (Topics and Format) with full F/G/E microcopy.

Purpose: Create the interactive multi-step experience that subscribers see after providing their email. The stepper shell with AnimatePresence transitions is the UX backbone; Topics and Format are the most complex and distinctive steps that define the product's personality.

Output: Working /onboarding route with stepper, progress bar, direction-aware step transitions, topic selection with expandable categories, and format choice -- all styled and animated.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-subscriber-onboarding/02-RESEARCH.md
@.planning/phases/02-subscriber-onboarding/02-01-SUMMARY.md
@lib/schemas/onboarding.ts
@lib/data/topics.ts
@app/globals.css
@components/ui/button.tsx
@components/ui/input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding route, stepper container, and progress bar</name>
  <files>app/onboarding/page.tsx, app/onboarding/layout.tsx, components/onboarding/stepper.tsx, components/onboarding/progress-bar.tsx</files>
  <action>
    **Layout** (`app/onboarding/layout.tsx`):
    Minimal layout for the onboarding flow. Include metadata (title: "Customize Your Briefing"). Simple centered container with max-width (e.g., max-w-2xl mx-auto). No marketing header/footer -- clean, focused experience.

    **Page** (`app/onboarding/page.tsx`):
    Server Component that reads `?subscriber=UUID` from searchParams. If no subscriber param, redirect to home page (the subscriber must come from the landing page email capture). Render the Stepper client component, passing subscriberId as a prop.

    **Stepper** (`components/onboarding/stepper.tsx`):
    'use client' component. This is the heart of the onboarding flow.

    State machine using `useReducer` with the pattern from RESEARCH.md:
    - State: `{ step: number, direction: 'forward' | 'back', data: OnboardingData }`
    - Actions: NEXT_STEP, PREV_STEP, UPDATE_DATA, RESET
    - Initial data defaults: format 'digest', deliveryTime 'morning', timezone auto-detected via `Intl.DateTimeFormat().resolvedOptions().timeZone`, empty arrays for topics/feedUrls, smsOptIn false

    Auto-detect timezone on mount using `useEffect` and dispatch UPDATE_DATA.

    Render the ProgressBar component showing current step (1-5).

    Use Framer Motion `AnimatePresence` with `mode="wait"` and `custom={state.direction}` for direction-aware step transitions. Use the `stepVariants` from RESEARCH.md (slides from right when going forward, from left when going back, with 0.3s ease).

    Render the current step component based on `state.step` (0=Topics, 1=Format, 2=DeliveryLocation, 3=SourcesSMS, 4=Confirmation).

    Each step receives: relevant slice of `state.data`, an `onUpdate` callback (dispatches UPDATE_DATA), `onNext` (dispatches NEXT_STEP), `onBack` (dispatches PREV_STEP). Step 0 has no Back button. Step 4 (Confirmation) is handled differently (no Next).

    Navigation buttons: "Back" (secondary style) and "Continue" / "Skip" at the bottom of each step. Per CONTEXT.md, only email (already captured) and browsing topics are required -- all other steps can be skipped. Show both "Continue" and "Skip this step" options on non-required steps (Format, Delivery, Sources).

    **Progress Bar** (`components/onboarding/progress-bar.tsx`):
    'use client' component. Visual progress indicator showing 5 steps. Builder's discretion for design -- use a segmented bar or numbered dots with connecting lines. Show step labels: "Topics", "Format", "Delivery", "Sources", "Done". Highlight current step, show completed steps as filled. Animate transitions with Framer Motion.
  </action>
  <verify>`npm run build` passes. Navigate to `/onboarding?subscriber=test-uuid` -- page renders without errors. Stepper mounts with Topics step visible. Progress bar shows step 1 of 5.</verify>
  <done>Onboarding route exists at /onboarding, stepper renders with useReducer state machine, AnimatePresence provides direction-aware transitions, and progress bar visually tracks the 5-step flow.</done>
</task>

<task type="auto">
  <name>Task 2: Build Topics step and Format step with F/G/E copy</name>
  <files>components/onboarding/step-topics.tsx, components/onboarding/topic-category-card.tsx, components/onboarding/step-format.tsx</files>
  <action>
    **Step Topics** (`components/onboarding/step-topics.tsx`):
    'use client' component. Two sections: category selection + custom topics textarea.

    F/G/E header: "What do you want to be ahead on?" (ego-framed, per CONTEXT.md COPY-02).
    Subtext: "Select topics that matter to you. We'll research them daily so you never miss what's important." (fear of missing + greed for exclusive info).

    Render `TOPIC_CATEGORIES` from `lib/data/topics.ts` as expandable cards/tiles. Each category shows its name and a "(Most Popular)" badge if `isPopular` is true. Clicking a category expands it to reveal subtopics. Subtopics are selectable (checkboxes or toggles). Selected subtopics are stored in `state.data.topics` as an array of subtopic IDs.

    Use `TopicCategoryCard` component for each category.

    Below the categories, a "Custom Topics" section with a textarea:
    Label: "Describe anything else you want covered" (or similar F/G/E framing)
    Placeholder: "e.g., 'Local coffee shop openings in Austin', 'New AI coding tools', 'Deals on running shoes'..."
    Max 500 chars. Stored in `state.data.customTopics`.

    Per CONTEXT.md: no minimum selection required. Subscriber can skip entirely.

    **Topic Category Card** (`components/onboarding/topic-category-card.tsx`):
    'use client' component. Props: category data, selected subtopic IDs, onToggleSubtopic callback.
    Renders a card with the category name, "(Most Popular)" badge if applicable, and an expand/collapse chevron.
    When expanded, shows subtopics as selectable chips/checkboxes.
    Use Framer Motion for expand/collapse animation (AnimatePresence with height transition).

    **Step Format** (`components/onboarding/step-format.tsx`):
    'use client' component.

    F/G/E header: "How do you want your intelligence delivered?" (ego-framed identity language).
    Subtext: "Choose the format that fits how you consume information." (greed for personalization).

    Three format cards/radio options:
    1. **Curated Digest** "(Most Popular)" -- "5-8 handpicked items with quick summaries and direct links. For the scanner who wants breadth fast." Icon: list/grid icon.
    2. **Written Briefing** -- "A narrative synthesis that connects the dots between stories. For the thinker who wants depth and context." Icon: document/text icon.
    3. **Mixed** -- "A short synthesis up top, then itemized links below. For the person who wants both the big picture and the details." Icon: hybrid icon.

    Identity-framed descriptions per CONTEXT.md: "For the scanner...", "For the thinker...", "For the person who wants both...". This is the ego frame -- subscribers self-identify with a type.

    Selected format stored in `state.data.format`. Default: 'digest'.

    Style as visually distinct cards with a selected state (border highlight, checkmark). Use Framer Motion for selection animation.
  </action>
  <verify>`npm run build` passes. Topics step renders 8 categories from TOPIC_CATEGORIES. Categories expand to show subtopics. Custom topics textarea accepts input. Format step shows 3 options with "(Most Popular)" on digest. Selecting a format updates the visual state.</verify>
  <done>Topics step shows expandable categories with "(Most Popular)" labels, subtopic selection, and custom topics textarea. Format step shows 3 identity-framed options with "(Most Popular)" default on digest. Both steps use F/G/E microcopy throughout.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `/onboarding?subscriber=test-uuid` renders the stepper at Topics step
- Progress bar shows 5 steps with "Topics" highlighted
- 8 topic categories render with "(Most Popular)" on Technology & AI, Business & Finance, Entertainment
- Clicking a category expands to show subtopics
- Subtopics can be selected/deselected
- Custom topics textarea accepts text up to 500 chars
- Clicking "Continue" transitions to Format step with slide animation
- Format step shows 3 options with "(Most Popular)" on Curated Digest
- Clicking "Back" transitions back to Topics with reverse slide animation
- All selections persist across back/forward navigation (useReducer state)
</verification>

<success_criteria>
A subscriber can navigate to /onboarding, see a progress bar, browse and select topics from expandable categories, add custom topics, proceed to the format step, choose a newsletter format, and navigate back without losing any selections. All copy uses F/G/E microcopy framework.
</success_criteria>

<output>
After completion, create `.planning/phases/02-subscriber-onboarding/02-02-SUMMARY.md`
</output>

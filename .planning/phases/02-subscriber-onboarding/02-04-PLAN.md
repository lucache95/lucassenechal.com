---
phase: 02-subscriber-onboarding
plan: 04
type: execute
wave: 3
depends_on: [02-02, 02-03]
files_modified:
  - components/onboarding/step-confirmation.tsx
  - app/actions.ts
  - lib/email/welcome-template.tsx
  - components/landing/hero.tsx
autonomous: true
requirements: [SIGN-01, SIGN-08, SIGN-09, COPY-02]

user_setup:
  - service: supabase
    why: "Subscriber preferences schema must exist in database"
    dashboard_config:
      - task: "Run migration 002_subscriber_preferences.sql in Supabase SQL Editor"
        location: "Supabase Dashboard -> SQL Editor -> paste migration SQL and run"

must_haves:
  truths:
    - "After completing all steps, subscriber sees a celebratory confirmation page with confetti animation"
    - "Confirmation page shows a summary of the subscriber's choices (topics, format, delivery time)"
    - "Confirmation page includes a share/referral CTA to invite friends"
    - "All onboarding data is persisted to Supabase (subscriber_preferences, subscriber_topics, subscriber_custom_topics, subscriber_sources)"
    - "Subscriber receives a welcome email with a sample briefing preview based on their selected topics"
    - "Landing page hero form redirects to /onboarding after successful email capture"
    - "Welcome email send does not block the signup completion (fire-and-forget)"
  artifacts:
    - path: "components/onboarding/step-confirmation.tsx"
      provides: "Celebratory confirmation page with confetti, choice summary, and share CTA"
      contains: "confetti"
    - path: "app/actions.ts"
      provides: "completeOnboarding Server Action that persists all preferences and sends welcome email"
      exports: ["subscribeEmail", "completeOnboarding"]
    - path: "lib/email/welcome-template.tsx"
      provides: "React Email welcome template with sample briefing preview"
      contains: "WelcomeEmail"
    - path: "components/landing/hero.tsx"
      provides: "Updated hero form that redirects to /onboarding on successful email capture"
      contains: "onboarding"
  key_links:
    - from: "components/onboarding/stepper.tsx"
      to: "app/actions.ts"
      via: "submits form data to completeOnboarding Server Action on final step"
      pattern: "completeOnboarding"
    - from: "app/actions.ts"
      to: "lib/email/welcome-template.tsx"
      via: "imports WelcomeEmail and passes to Resend"
      pattern: "import.*WelcomeEmail"
    - from: "app/actions.ts"
      to: "lib/schemas/onboarding.ts"
      via: "validates form data with onboardingSchema"
      pattern: "onboardingSchema"
    - from: "components/landing/hero.tsx"
      to: "app/onboarding/page.tsx"
      via: "redirects to /onboarding?subscriber=UUID after email capture"
      pattern: "/onboarding"
    - from: "app/actions.ts"
      to: "supabase subscriber_preferences table"
      via: "inserts into subscriber_preferences, subscriber_topics, subscriber_custom_topics, subscriber_sources"
      pattern: "supabase.*from.*subscriber"
---

<objective>
Build the confirmation step with celebration UX, create the completeOnboarding Server Action that persists all preferences to Supabase, build the React Email welcome template, and wire the landing page to redirect to /onboarding after email capture.

Purpose: This plan completes the end-to-end subscriber onboarding flow. It connects the frontend stepper to the backend persistence, sends the welcome email, and wires the entry point from the landing page. After this plan, a visitor can go from landing page email capture through the full onboarding flow to confirmation.

Output: Complete working onboarding pipeline -- landing page -> email capture -> /onboarding stepper -> preferences saved -> welcome email sent -> confirmation displayed.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-subscriber-onboarding/02-RESEARCH.md
@.planning/phases/02-subscriber-onboarding/02-01-SUMMARY.md
@.planning/phases/02-subscriber-onboarding/02-02-SUMMARY.md
@.planning/phases/02-subscriber-onboarding/02-03-SUMMARY.md
@app/actions.ts
@lib/schemas/onboarding.ts
@lib/data/topics.ts
@components/landing/hero.tsx
@components/onboarding/stepper.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create confirmation step and wire landing page redirect</name>
  <files>components/onboarding/step-confirmation.tsx, components/landing/hero.tsx</files>
  <action>
    **Confirmation Step** (`components/onboarding/step-confirmation.tsx`):
    'use client' component. Step 5 (index 4) of the onboarding flow.

    On mount, fire confetti burst using `canvas-confetti`:
    ```typescript
    import confetti from 'canvas-confetti';
    useEffect(() => {
      confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }, []);
    ```

    **F/G/E header:** "You're all set. Your edge starts tomorrow." (ego -- you've taken action, you're ahead now).
    **Subtext:** "Here's what we'll be researching just for you." (greed -- exclusive, personalized).

    **Choice Summary Section:**
    Display a clean summary of their selections:
    - **Topics:** List selected category/subtopic names (resolve IDs from TOPIC_CATEGORIES data). If none selected, show "General briefing -- a curated mix of trending topics."
    - **Custom Topics:** Show their custom text if provided.
    - **Format:** Show chosen format name with a brief description.
    - **Delivery:** Show time slot and city (if provided). Show timezone.
    - **Sources:** Count of custom feeds added (if any).
    - **SMS:** "SMS alerts enabled" or omit if not opted in.

    **Share/Referral CTA:**
    "Know someone who'd want their own daily briefing?" (greed -- give the gift of being informed).
    Share button that copies the site URL to clipboard (navigator.clipboard.writeText) with a "Copied!" toast/feedback. Alternatively, show social share links (Twitter/X share intent URL, email mailto: link).

    **First Delivery Expectation:**
    "Your first briefing arrives tomorrow at [morning/afternoon/evening]. Check your inbox (and spam folder)." (practical + the spam folder note from Phase 1 feedback).

    This step does NOT have Next/Continue buttons. Instead, it has a "Visit homepage" or "Done" link back to the landing page.

    **Landing Page Hero Update** (`components/landing/hero.tsx`):
    Modify the hero email capture form's success handler. Currently, on successful subscribeEmail, it shows a success message. Change it to:

    1. The `subscribeEmail` Server Action needs to return the subscriber's UUID on success (currently returns `{ success: true }` -- update to `{ success: true, subscriberId: string }`).
    2. On success, instead of just showing a message, redirect to `/onboarding?subscriber=<uuid>` after a brief delay (~1.5s) showing "Taking you to customize your briefing..." with a loading state.
    3. Use `window.location.href = /onboarding?subscriber=${subscriberId}` for the redirect (or Next.js `useRouter().push()`). Import `useRouter` from `next/navigation` if using the latter.

    Also update the `subscribeEmail` action in `app/actions.ts` to return the subscriber ID:
    - After successful insert, query for the subscriber by email to get the UUID (or use Supabase's `.select('id').single()` on the insert to return the ID directly).
    - Return `{ success: true, subscriberId: data.id }`.
    - Update the `SubscribeResult` type to include `subscriberId?: string`.

    Similarly update `components/landing/sticky-cta.tsx` if it has the same email form pattern -- it should also redirect to onboarding on success.
  </action>
  <verify>`npm run build` passes. Confirmation step renders with confetti on mount. Choice summary displays data from stepper state. Share button copies URL to clipboard. Landing page hero form, after successful email submit, shows redirect message and navigates to /onboarding?subscriber=UUID.</verify>
  <done>Confirmation step displays celebration with confetti, choice summary, share CTA, and delivery expectation. Landing page forms redirect to /onboarding with subscriber UUID after successful email capture. subscribeEmail Server Action returns subscriber ID.</done>
</task>

<task type="auto">
  <name>Task 2: Create completeOnboarding Server Action and welcome email template</name>
  <files>app/actions.ts, lib/email/welcome-template.tsx</files>
  <action>
    **completeOnboarding Server Action** (in `app/actions.ts`):
    Add a new exported Server Action `completeOnboarding` alongside the existing `subscribeEmail`.

    Pattern: consistent with existing subscribeEmail -- 'use server', typed result, Zod validation.

    ```typescript
    type OnboardingResult = { success?: boolean; error?: string };

    export async function completeOnboarding(
      _prevState: OnboardingResult,
      formData: FormData
    ): Promise<OnboardingResult> {
      // 1. Parse JSON payload from hidden form input
      const rawData = formData.get('onboardingData');
      if (!rawData || typeof rawData !== 'string') {
        return { error: 'Invalid form data' };
      }

      // 2. Validate with shared Zod schema
      const parsed = onboardingSchema.safeParse(JSON.parse(rawData));
      if (!parsed.success) {
        return { error: parsed.error.errors[0]?.message || 'Validation failed' };
      }

      // 3. Create Supabase client with service_role
      const supabase = createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
      );

      // 4. Write to Supabase tables (check each result for errors):
      //    a. subscriber_preferences (format, delivery_time, timezone, city, sms_opt_in, phone)
      //    b. subscriber_topics (for each selected subtopic ID, resolve name to DB UUID, insert junction row)
      //    c. subscriber_custom_topics (if customTopics is non-empty)
      //    d. subscriber_sources (for each feedUrl)

      // For topic resolution: query topic_subtopics by name to get UUID, then insert into subscriber_topics.
      // This is because the client stores slug IDs from lib/data/topics.ts, and the DB has UUIDs.
      // Query: supabase.from('topic_subtopics').select('id, name')
      // Then match client slugs to DB names.

      // Write subscriber_preferences FIRST (core data).
      // Then write topics, custom_topics, sources (supplementary).
      // If supplementary writes fail, log error but still return success (per Pitfall 4 guidance).

      // 5. Update subscriber status from 'pending' to 'active'
      //    supabase.from('subscribers').update({ status: 'active' }).eq('id', subscriberId)

      // 6. Send welcome email (fire-and-forget per Pitfall 5)
      //    Import WelcomeEmail from lib/email/welcome-template
      //    Get subscriber email from DB
      //    Fire resend.emails.send() WITHOUT await -- wrap in try/catch that just logs errors
      //    Do NOT let email failure block the signup response

      return { success: true };
    }
    ```

    **Important implementation details:**
    - The topic slug-to-UUID resolution: query `topic_subtopics` joining `topic_categories`, then build a map of `categorySlug-subtopicSlug` -> UUID. Match against the client's topic IDs.
    - Actually, simpler approach: store subtopic names (not slugs) in the client data, and query `topic_subtopics` by name. Even simpler: store the subtopic `name` field directly, and look it up. Make sure `lib/data/topics.ts` uses names that exactly match the DB seed.
    - Fire-and-forget for email: use `resend.emails.send(...).catch(err => console.error('[welcome-email]', err))` without await.

    **Also update the stepper** (`components/onboarding/stepper.tsx`) to:
    - Import `useActionState` from 'react' and `completeOnboarding` from '@/app/actions'
    - On the final step (when user is on step 4 Confirmation), automatically submit the form data via a hidden form with the Server Action
    - The submission happens when transitioning FROM step 3 TO step 4 (the "Finish" button on step 3)
    - Use a hidden `<form>` with a hidden input containing JSON.stringify(state.data) and action={completeOnboarding}
    - Show a loading state while the action runs, then show confirmation step on success
    - On error, show the error message and allow retry

    **Welcome Email Template** (`lib/email/welcome-template.tsx`):
    React Email component using @react-email/components.

    ```typescript
    import { Html, Head, Body, Container, Heading, Text, Section, Hr, Link } from '@react-email/components';
    ```

    Props: `{ topics: string[], customTopics: string, format: string, deliveryTime: string }`.

    Design:
    - Clean, minimal design matching the website's slate/blue aesthetic
    - From: "Lucas Senechal <newsletter@lucassenechal.com>"
    - Subject: "Your daily edge starts tomorrow"
    - Header: "Your daily edge starts tomorrow" (ego)
    - Body: Brief welcome message + "Here's a preview of what your first briefing will look like..."
    - Sample briefing section: If topics selected, show 3-4 mock items related to their first topic category (e.g., for "Technology & AI": "OpenAI releases GPT-5 preview...", "New VS Code AI extension..."). If no topics, show a generic diverse sample.
    - Format mention: "Delivered as a [format name] every [morning/afternoon/evening]"
    - Footer: "Check your spam folder and mark us as 'not spam' to never miss a briefing."
    - Preference link placeholder: "Update your preferences anytime" (link placeholder for Phase 6)

    Use inline styles (required for email clients). Keep it simple and professional.

    If no topics selected: show a generic sample with 3-4 diverse items (one tech, one business, one lifestyle, one local).
  </action>
  <verify>`npm run build` passes. `app/actions.ts` exports both `subscribeEmail` and `completeOnboarding`. Welcome email template renders without errors. Stepper submits form data to Server Action when finishing. Server Action validates with Zod and writes to Supabase tables. Welcome email fires without blocking.</verify>
  <done>completeOnboarding Server Action validates all onboarding data, persists to 4 Supabase tables, updates subscriber status to 'active', and sends welcome email fire-and-forget. Welcome email template shows personalized sample briefing preview based on selected topics. Stepper submits data on completion. Full end-to-end flow works: landing page -> email capture -> redirect to /onboarding -> complete steps -> data saved -> email sent -> confirmation shown.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `app/actions.ts` exports both `subscribeEmail` and `completeOnboarding`
- `subscribeEmail` returns `subscriberId` on success
- `completeOnboarding` validates with Zod, writes to subscriber_preferences, subscriber_topics, subscriber_custom_topics, subscriber_sources
- `completeOnboarding` updates subscriber status from 'pending' to 'active'
- Welcome email template renders with sample briefing content
- Email send is fire-and-forget (does not block response)
- Landing page hero redirects to /onboarding?subscriber=UUID after email capture
- Confirmation step shows confetti and choice summary
- Full flow: landing page email -> /onboarding stepper -> preferences saved -> email sent -> confirmation
</verification>

<success_criteria>
Complete end-to-end onboarding flow works: visitor enters email on landing page, gets redirected to /onboarding, completes (or skips) all 5 steps, preferences are persisted to Supabase, welcome email is sent, and a celebratory confirmation page is displayed with their choices summarized and a share CTA.
</success_criteria>

<output>
After completion, create `.planning/phases/02-subscriber-onboarding/02-04-SUMMARY.md`
</output>

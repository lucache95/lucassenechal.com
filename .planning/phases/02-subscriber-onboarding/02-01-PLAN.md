---
phase: 02-subscriber-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/002_subscriber_preferences.sql
  - lib/schemas/onboarding.ts
  - lib/data/topics.ts
  - package.json
  - next.config.ts
autonomous: true
requirements: [SIGN-02, SIGN-04, SIGN-05, SIGN-06, SIGN-07]

must_haves:
  truths:
    - "Zod onboarding schema validates all preference fields (topics, format, delivery time, timezone, city, feeds, SMS, phone)"
    - "Topic categories and subtopics are defined with display order and popularity flags"
    - "Supabase migration creates all preference tables with correct foreign keys, RLS, and seed data"
    - "New dependencies (zod, @react-email/components, @react-email/render, canvas-confetti) are installed"
  artifacts:
    - path: "supabase/migrations/002_subscriber_preferences.sql"
      provides: "Preference schema with 6 tables, RLS policies, and seed data"
      contains: "CREATE TABLE subscriber_preferences"
    - path: "lib/schemas/onboarding.ts"
      provides: "Shared Zod validation schema for onboarding form"
      exports: ["onboardingSchema", "OnboardingData"]
    - path: "lib/data/topics.ts"
      provides: "Static topic category and subtopic data structure"
      exports: ["TOPIC_CATEGORIES"]
    - path: "next.config.ts"
      provides: "serverExternalPackages for react-email"
      contains: "serverExternalPackages"
  key_links:
    - from: "lib/schemas/onboarding.ts"
      to: "lib/data/topics.ts"
      via: "topic IDs referenced in schema defaults"
      pattern: "import.*topics"
    - from: "lib/data/topics.ts"
      to: "supabase/migrations/002_subscriber_preferences.sql"
      via: "category/subtopic IDs matching DB seed data"
      pattern: "id:.*category"
---

<objective>
Install Phase 2 dependencies, create the Supabase preference schema migration, define the Zod validation schema, and build the topic category data structure.

Purpose: Establish the data foundation that all onboarding UI components and the Server Action will depend on. Without the schema, validation, and topic data, no step component can be built correctly.

Output: Database migration SQL, shared Zod schema, static topic data file, updated package.json and next.config.ts.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-subscriber-onboarding/02-RESEARCH.md
@package.json
@next.config.ts
@supabase/migrations/001_subscribers.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure next.config.ts</name>
  <files>package.json, next.config.ts</files>
  <action>
    Install new dependencies:
    ```bash
    npm install zod @react-email/components @react-email/render canvas-confetti
    npm install -D @types/canvas-confetti
    ```

    Update `next.config.ts` to add `serverExternalPackages` for React Email:
    ```typescript
    const nextConfig: NextConfig = {
      output: "standalone",
      serverExternalPackages: ['@react-email/components', '@react-email/render'],
    };
    ```

    This prevents Next.js from trying to bundle react-email packages client-side (they use Node.js APIs). Per RESEARCH.md Pitfall 6.
  </action>
  <verify>`npm run build` completes without errors. `node -e "require('zod')"` and `node -e "require('canvas-confetti')"` succeed.</verify>
  <done>All 4 new dependencies installed in package.json, @types/canvas-confetti in devDependencies, and next.config.ts includes serverExternalPackages array.</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase migration, Zod schema, and topic data</name>
  <files>supabase/migrations/002_subscriber_preferences.sql, lib/schemas/onboarding.ts, lib/data/topics.ts</files>
  <action>
    **Migration file** (`supabase/migrations/002_subscriber_preferences.sql`):
    Create the full preference schema from RESEARCH.md with these tables:
    - `topic_categories` (id UUID, name TEXT UNIQUE, display_order INT, is_popular BOOLEAN) -- seed with 8 categories
    - `topic_subtopics` (id UUID, category_id UUID FK, name TEXT, display_order INT) -- seed with 4-6 subtopics per category
    - `subscriber_topics` (subscriber_id UUID FK, subtopic_id UUID FK, created_at) -- junction table, composite PK
    - `subscriber_preferences` (subscriber_id UUID PK FK, format TEXT CHECK, delivery_time TEXT CHECK, timezone TEXT, city TEXT, sms_opt_in BOOLEAN, phone TEXT, created_at, updated_at)
    - `subscriber_custom_topics` (id UUID, subscriber_id UUID FK, description TEXT, created_at)
    - `subscriber_sources` (id UUID, subscriber_id UUID FK, feed_url TEXT, created_at, UNIQUE subscriber+url)

    Include indexes, RLS policies (anon can read topic_categories and topic_subtopics; deny all other anon access; service_role full access on all tables). Include seed data for all 8 categories and their subtopics.

    Subtopic seed data (4-6 per category):
    - Technology & AI: AI Tools & Assistants, Software Development, Cybersecurity, Gadgets & Hardware, Cloud & Infrastructure, Startups
    - Business & Finance: Markets & Investing, Entrepreneurship, Real Estate, Personal Finance, Crypto & Web3
    - Health & Wellness: Fitness & Exercise, Nutrition & Diet, Mental Health, Sleep Science, Longevity
    - Local & Community: Local Events, Restaurant & Food Scene, Community News, Real Estate Market, Local Business
    - Entertainment: Movies & TV, Music, Gaming, Books & Podcasts, Celebrity & Culture
    - Science & Innovation: Space & Astronomy, Climate & Environment, Biotechnology, Physics & Engineering, Emerging Tech
    - Lifestyle: Travel, Food & Cooking, Home & Garden, Fashion, Parenting
    - Sports: NFL & College Football, NBA & Basketball, Soccer, Fantasy Sports, Combat Sports

    **Zod schema** (`lib/schemas/onboarding.ts`):
    Create and export `onboardingSchema` and `OnboardingData` type exactly as specified in RESEARCH.md:
    - `subscriberId`: z.string().uuid()
    - `topics`: z.array(z.string()).default([]) -- stores subtopic IDs as strings
    - `customTopics`: z.string().max(500).default('')
    - `format`: z.enum(['digest', 'briefing', 'mixed']).default('digest')
    - `deliveryTime`: z.enum(['morning', 'afternoon', 'evening']).default('morning')
    - `timezone`: z.string().default('UTC')
    - `city`: z.string().max(100).default('')
    - `feedUrls`: z.array(z.string().url() with http/https protocol check).default([])
    - `smsOptIn`: z.boolean().default(false)
    - `phone`: z.string().default('') with E.164-like regex validation (empty or +digits)

    **Topic data** (`lib/data/topics.ts`):
    Export `TOPIC_CATEGORIES` as a typed array matching the DB seed data. Each category has: `id` (stable slug string like 'technology-ai'), `name`, `displayOrder`, `isPopular`, and `subtopics` array (each subtopic has `id` slug, `name`, `displayOrder`). These IDs are what get stored in the form state and sent to the Server Action. The Server Action will look up DB UUIDs by name.

    Use stable slug-based IDs (e.g., 'technology-ai', 'ai-tools-assistants') rather than UUIDs so the client-side data file doesn't need to know DB-generated UUIDs. The Server Action will resolve slugs to UUIDs when persisting.
  </action>
  <verify>`npx tsc --noEmit` passes. Migration SQL is valid (no syntax errors). Schema exports `onboardingSchema` and `OnboardingData`. Topics file exports `TOPIC_CATEGORIES` with 8 categories each containing subtopics.</verify>
  <done>Migration SQL ready for Supabase deployment. Zod schema provides shared client/server validation. Topic data structure defines all 8 categories with subtopics, matching the DB seed data by name.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with new dependencies and next.config.ts changes
- `npx tsc --noEmit` passes with no type errors
- `lib/schemas/onboarding.ts` exports `onboardingSchema` and `OnboardingData`
- `lib/data/topics.ts` exports `TOPIC_CATEGORIES` with 8 categories
- `supabase/migrations/002_subscriber_preferences.sql` contains all 6 table definitions with RLS and seed data
- `next.config.ts` includes `serverExternalPackages` array
</verification>

<success_criteria>
All Phase 2 data dependencies are in place: Zod schema validates the complete onboarding form, topic categories are defined with subtopics, database migration is ready, and React Email packages are properly configured for server-side usage.
</success_criteria>

<output>
After completion, create `.planning/phases/02-subscriber-onboarding/02-01-SUMMARY.md`
</output>

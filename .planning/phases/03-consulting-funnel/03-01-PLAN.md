---
phase: 03-consulting-funnel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/data/intake-questions.ts
  - lib/data/services.ts
  - lib/schemas/intake.ts
  - lib/schemas/business-plan.ts
  - supabase/migrations/003_intake_sessions.sql
autonomous: true
requirements: [WORK-04, WORK-11]
user_setup:
  - service: anthropic
    why: "AI-powered question selection and business plan generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key (https://console.anthropic.com/)"
    dashboard_config: []
  - service: cal.com
    why: "Booking embed for discovery calls"
    env_vars:
      - name: NEXT_PUBLIC_CAL_SPOTS_REMAINING
        source: "Manual count — how many consulting spots available this month"
      - name: NEXT_PUBLIC_CAL_SPOTS_MONTH
        source: "Current month name (e.g., 'March')"
    dashboard_config: []

must_haves:
  truths:
    - "Curated question library contains ~20 questions covering all WORK-04 categories (business, workflow, stack, scope, pain, timeline)"
    - "Question library has hard caps: MIN_QUESTIONS=6, STAGE_1_CAP=12, DEEP_DIVE_CAP=8"
    - "Business plan Zod schema covers all WORK-06 sections (goal mirroring, bottleneck, system steps, tools, phases, risks, estimate, next steps)"
    - "Supabase migration creates intake_sessions, intake_answers, and intake_plans tables with RLS"
  artifacts:
    - path: "lib/data/intake-questions.ts"
      provides: "Curated question library with typed IntakeQuestion interface"
      contains: "INTAKE_QUESTIONS"
    - path: "lib/data/services.ts"
      provides: "4 service definitions reusable by consulting page and plan output"
      contains: "SERVICES"
    - path: "lib/schemas/intake.ts"
      provides: "Zod schemas for intake answers, session, and validation"
      exports: ["intakeAnswerSchema", "intakeSessionSchema"]
    - path: "lib/schemas/business-plan.ts"
      provides: "Zod schema for structured business plan output"
      exports: ["businessPlanSchema", "BusinessPlan"]
    - path: "supabase/migrations/003_intake_sessions.sql"
      provides: "Database tables for intake data persistence"
      contains: "CREATE TABLE intake_sessions"
  key_links:
    - from: "lib/data/intake-questions.ts"
      to: "lib/schemas/intake.ts"
      via: "Question IDs referenced in answer schema validation"
      pattern: "questionId.*string"
---

<objective>
Install AI SDK dependencies, create the curated intake question library, define all Zod schemas (intake + business plan), create reusable service data, and write the Supabase migration for intake data persistence.

Purpose: Foundation data and schemas that all subsequent consulting funnel plans depend on. Without the question library, the AI cannot select questions. Without the schemas, neither the API routes nor the UI can validate data. Without the migration, intake data cannot persist.

Output: Static data files, Zod schemas, SQL migration, npm dependencies installed.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-consulting-funnel/03-RESEARCH.md
@components/homepage/what-i-build.tsx
@lib/data/topics.ts
@lib/schemas/onboarding.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create question library + service data</name>
  <files>
    package.json
    lib/data/intake-questions.ts
    lib/data/services.ts
  </files>
  <action>
Install AI SDK and PDF dependencies:
```bash
npm install ai @ai-sdk/react @ai-sdk/anthropic @react-pdf/renderer
```

Note: Do NOT install @calcom/embed-react (React 19 peer dep conflict). Cal.com embed will use vanilla JS script tag in a later plan.

Create `lib/data/intake-questions.ts` with:
- `IntakeQuestion` interface with fields: id (string), category ('business' | 'workflow' | 'stack' | 'scope' | 'pain' | 'timeline' | 'deep'), text (string), inputType ('buttons' | 'text' | 'slider' | 'multi-select'), options? (string[]), sliderConfig? ({ min, max, step, labels }), isRequired (boolean), isDeepDive (boolean), priority (number), aiContext (string describing when to pick this question)
- Export `INTAKE_QUESTIONS` array with ~20 questions covering ALL WORK-04 categories:
  - business: "What does your business do?" (text, priority 1), "How big is your team?" (buttons: Just me/2-5/6-20/21-50/50+, priority 2)
  - workflow: "Which workflow eats the most time?" (text, priority 3), "How do you currently handle [that workflow]?" (text, priority 5)
  - stack: "What tools does your team use daily?" (multi-select: Slack/Teams/Gmail/Sheets/Salesforce/HubSpot/Notion/Other, priority 6), "Do you use any automation tools today?" (buttons: Yes actively/Tried but failed/No/Not sure, priority 8)
  - scope: "What would 'done' look like for this project?" (text, priority 7), "How many people touch this workflow daily?" (slider: 1-50, priority 10)
  - pain: "What's the biggest bottleneck in your current process?" (text, priority 4), "How many hours per week does your team spend on this?" (slider: 1-40, priority 9), "What happens when this process breaks?" (text, priority 11)
  - timeline: "When do you need this running?" (buttons: ASAP/1-2 months/3-6 months/No rush, priority 12), "Do you have a budget range in mind?" (buttons: Under $5K/$5-15K/$15-50K/$50K+/Not sure, priority 13)
  - deep (isDeepDive=true): "Where does data currently live?" (text, priority 14), "What does your reporting/metrics stack look like?" (text, priority 15), "Who are the stakeholders for this project?" (text, priority 16), "What's been tried before that didn't work?" (text, priority 17), "Are there compliance or security requirements?" (buttons: HIPAA/SOC2/GDPR/PCI/None/Not sure, priority 18), "What does success look like in 6 months?" (text, priority 19), "How do you handle handoffs between team members?" (text, priority 20)
- Export constants: `MIN_QUESTIONS = 6`, `STAGE_1_CAP = 12`, `DEEP_DIVE_CAP = 8`
- Non-deep-dive questions have isDeepDive=false. Deep-dive questions are only offered after minimum is reached.

Create `lib/data/services.ts` with:
- `Service` interface with fields: id (string slug), icon (string emoji), title (string), description (string), longDescription (string)
- Export `SERVICES` array with the same 4 services already defined in `components/homepage/what-i-build.tsx`:
  1. ai-automation: "Turn repetitive workflows into AI-powered systems that run themselves."
  2. process-consulting: "Audit your operations and design the automation roadmap."
  3. ongoing-management: "Keep your AI systems running, improving, and scaling with you."
  4. training: "Get your team confident building and working alongside AI."
- Add `longDescription` field with 1-2 sentences expanding each service (for the consulting page cards).
- This file becomes the single source of truth. Later, WhatIBuild component can import from here.
  </action>
  <verify>
`npm ls ai @ai-sdk/react @ai-sdk/anthropic @react-pdf/renderer` shows all installed.
`npx tsc --noEmit lib/data/intake-questions.ts lib/data/services.ts` compiles without errors.
Question count: at least 18 questions total, with at least 12 non-deep-dive and at least 6 deep-dive.
  </verify>
  <done>
AI SDK and PDF dependencies installed. Curated question library has ~20 typed questions covering all WORK-04 categories with priority ordering, input types, and AI context hints. Service data is extracted into reusable module. MIN_QUESTIONS=6, STAGE_1_CAP=12, DEEP_DIVE_CAP=8 constants exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod schemas and Supabase migration</name>
  <files>
    lib/schemas/intake.ts
    lib/schemas/business-plan.ts
    supabase/migrations/003_intake_sessions.sql
  </files>
  <action>
Create `lib/schemas/intake.ts` with:
- `intakeAnswerSchema`: z.object with questionId (string), questionText (string), answerValue (string), answerDisplay (string), sequenceOrder (number)
- `intakeSessionSchema`: z.object with email (z.string().email()), name (z.string().min(1)), answers (z.array(intakeAnswerSchema))
- `nextQuestionResponseSchema`: z.object with questionId (string), inputType (z.enum(['buttons', 'text', 'slider', 'multi-select'])), options (z.array(z.string()).optional()), skipReason (z.string().optional())
- Export all schemas and inferred types (IntakeAnswer, IntakeSession, NextQuestionResponse)
- Follow project pattern from `lib/schemas/onboarding.ts` — Zod 4 syntax

Create `lib/schemas/business-plan.ts` with the full business plan schema per WORK-06 and research:
- `businessPlanSchema`: z.object with:
  - goalMirroring: z.string().describe('Restate client situation in cleaner language. 2-3 sentences showing deep understanding. Paraphrase, do not quote directly.')
  - bottleneckDiagnosis: z.string().describe('Identify the core bottleneck(s) causing their pain. Be specific to their workflow.')
  - proposedSystemSteps: z.array(z.object({ step: z.number(), title: z.string(), description: z.string(), tools: z.array(z.string()).optional() })).describe('Proposed system architecture steps in order')
  - toolsAndIntegrations: z.array(z.string()).describe('Specific tools and integrations needed')
  - implementationPhases: z.array(z.object({ phase: z.string().describe('Phase name: MVP, Hardening, or Reporting'), duration: z.string().describe('Estimated duration like "2-3 weeks"'), deliverables: z.array(z.string()) })).describe('Implementation phases: MVP -> Hardening -> Reporting')
  - risksAndDependencies: z.array(z.string()).describe('Key risks and dependencies to flag')
  - estimate: z.object({ totalRange: z.string().describe('Total cost range'), timeline: z.string().describe('Total timeline'), assumptions: z.array(z.string()) })
  - nextSteps: z.array(z.string()).describe('Clear next steps for the prospect')
  - recommendedService: z.enum(['ai-automation', 'process-consulting', 'ongoing-management', 'training']).describe('Which of the 4 services best fits')
- Export schema and `BusinessPlan` type (z.infer)
- Use `.describe()` on every field to guide AI generation. Use `.optional()` on non-critical fields (tools in proposedSystemSteps) for schema flexibility.

Create `supabase/migrations/003_intake_sessions.sql` with:
- `intake_sessions` table: id (UUID PK), email (TEXT NOT NULL), name (TEXT NOT NULL), status (TEXT DEFAULT 'in_progress' CHECK IN ('in_progress','plan_generated','booked','abandoned')), created_at, updated_at, plan_generated_at (nullable), booked_at (nullable)
- `intake_answers` table: id (UUID PK), session_id (FK to intake_sessions ON DELETE CASCADE), question_id (TEXT), question_text (TEXT), answer_value (TEXT), answer_display (TEXT), sequence_order (INT), created_at
- `intake_plans` table: id (UUID PK), session_id (FK UNIQUE to intake_sessions ON DELETE CASCADE), plan_json (JSONB), recommended_service (TEXT), created_at
- Indexes on email, status, session_id
- RLS enabled on all tables. Service role full access policies. Deny all public/anon access.
- Follow exact pattern from 03-RESEARCH.md SQL example.
  </action>
  <verify>
`npx tsc --noEmit lib/schemas/intake.ts lib/schemas/business-plan.ts` compiles without errors.
SQL migration file exists and contains CREATE TABLE for all 3 tables.
Business plan schema has all 9 required fields from WORK-06.
  </verify>
  <done>
Intake and business plan Zod schemas created with full type exports. Supabase migration ready for SQL Editor execution. All WORK-06 plan sections represented in schema. All schemas use Zod 4 syntax with .describe() for AI guidance.
  </done>
</task>

</tasks>

<verification>
- `npm ls ai @ai-sdk/react @ai-sdk/anthropic @react-pdf/renderer` all resolve
- `npx tsc --noEmit` passes for all new files
- Question library has 18-20 questions with correct TypeScript types
- Business plan schema has all 9 sections from WORK-06
- SQL migration follows project's RLS pattern
</verification>

<success_criteria>
All AI SDK dependencies installed. Curated question library with ~20 typed questions covering every WORK-04 category. Business plan schema with all WORK-06 sections. Service data extracted to reusable module. Supabase migration ready. All files type-check cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-consulting-funnel/03-01-SUMMARY.md`
</output>

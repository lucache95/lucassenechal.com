---
phase: 03-consulting-funnel
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - app/api/intake/next-question/route.ts
  - components/intake/intake-container.tsx
  - components/intake/question-card.tsx
  - components/intake/smart-input.tsx
  - components/intake/intake-progress.tsx
  - app/(marketing)/work-with-me/work-with-me-client.tsx
autonomous: true
requirements: [WORK-03, WORK-05, WORK-09, WORK-10]

must_haves:
  truths:
    - "AI selects next question from curated library based on prior answers (never invents new questions)"
    - "One question displayed at a time, centered on screen, with answer input below — Typeform/survey feel"
    - "Smart inputs render correct type per question: buttons for choices, text for open-ended, slider for ranges, multi-select"
    - "Back button navigates to previous question; skip link available but non-prominent"
    - "Progress indicator shows completion and switches to 'Generate plan now OR Answer more' once minimum (~6-8) questions reached"
    - "Question selection latency is under 2 seconds (Claude Haiku)"
    - "After minimum questions, visitor can keep answering or generate plan — single continuous flow"
  artifacts:
    - path: "app/api/intake/next-question/route.ts"
      provides: "AI question selection Route Handler using Claude Haiku"
      exports: ["POST"]
    - path: "components/intake/intake-container.tsx"
      provides: "State machine managing intake flow, answer history, and AI question fetching"
      contains: "IntakeContainer"
    - path: "components/intake/question-card.tsx"
      provides: "Single question display with animation"
      contains: "QuestionCard"
    - path: "components/intake/smart-input.tsx"
      provides: "Renders correct input type per question (buttons, text, slider, multi-select)"
      contains: "SmartInput"
    - path: "components/intake/intake-progress.tsx"
      provides: "Adaptive progress bar with minimum-reached state"
      contains: "IntakeProgress"
  key_links:
    - from: "components/intake/intake-container.tsx"
      to: "app/api/intake/next-question/route.ts"
      via: "fetch POST to get next question ID from AI"
      pattern: "fetch.*api/intake/next-question"
    - from: "app/api/intake/next-question/route.ts"
      to: "lib/data/intake-questions.ts"
      via: "imports question pool, filters by already-answered"
      pattern: "INTAKE_QUESTIONS"
    - from: "components/intake/intake-container.tsx"
      to: "components/intake/question-card.tsx"
      via: "passes current question + onAnswer callback"
      pattern: "QuestionCard.*question"
    - from: "app/(marketing)/work-with-me/work-with-me-client.tsx"
      to: "components/intake/intake-container.tsx"
      via: "renders IntakeContainer in intake stage"
      pattern: "IntakeContainer"
---

<objective>
Build the AI-powered smart intake experience: an API route that selects the next question from the curated library using Claude Haiku, and the full intake UI with one-question-at-a-time display, smart inputs, progress tracking, back/skip navigation, and the "generate plan now or answer more" choice once minimum questions are reached.

Purpose: This is the core interactive experience — a conversational intake that feels fast and intelligent. The AI adapts question order based on prior answers while staying within the curated library guardrails. The progress system encourages completion without feeling pushy.

Output: Working intake flow integrated into the /work-with-me page state machine.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-consulting-funnel/03-RESEARCH.md
@.planning/phases/03-consulting-funnel/03-01-SUMMARY.md
@.planning/phases/03-consulting-funnel/03-02-SUMMARY.md
@lib/data/intake-questions.ts
@lib/schemas/intake.ts
@app/(marketing)/work-with-me/work-with-me-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI question selection API route</name>
  <files>
    app/api/intake/next-question/route.ts
  </files>
  <action>
Create `app/api/intake/next-question/route.ts`:

- Import `generateText`, `Output` from 'ai' (AI SDK v6 pattern — NOT generateObject standalone)
- Import `anthropic` from '@ai-sdk/anthropic'
- Import `z` from 'zod'
- Import `INTAKE_QUESTIONS`, `MIN_QUESTIONS`, `STAGE_1_CAP` from '@/lib/data/intake-questions'
- Import `nextQuestionResponseSchema` from '@/lib/schemas/intake'

POST handler:
1. Parse request body: `{ answeredQuestionIds: string[], answers: { questionId: string, answerValue: string }[], questionCount: number }`
2. Filter remaining questions: `INTAKE_QUESTIONS.filter(q => !answeredQuestionIds.includes(q.id))`
3. If questionCount < STAGE_1_CAP, also filter out isDeepDive=true questions
4. If no remaining questions, return `{ done: true }` response
5. Call `generateText` with:
   - model: `anthropic('claude-3-5-haiku-20241022')` — fast and cheap for selection
   - output: `Output.object({ schema: nextQuestionResponseSchema })`
   - system prompt: "You are selecting the next intake question for a consulting prospect seeking AI automation services. Select the most valuable next question based on what they've already answered. Only return a questionId from the provided pool. Never invent new questions. Pick questions that fill the biggest knowledge gaps about their business needs."
   - prompt: JSON of prior answers + remaining question pool (id, text, category, inputType, options, aiContext)
6. Implement timeout fallback: if AI call takes > 1500ms, abort and use deterministic fallback (next highest-priority unasked question sorted by priority field)
7. Use `AbortController` with `setTimeout(1500)` for the timeout. On abort, select the remaining question with lowest priority number.
8. Return JSON response with the selected question data (full question object + AI-suggested inputType/options override if applicable)

Error handling:
- If ANTHROPIC_API_KEY is not set, fall back to deterministic selection immediately
- Log fallback events for monitoring: `console.warn('AI question selection fallback:', reason)`
- Always return a valid question — never leave the user stuck
  </action>
  <verify>
`npx tsc --noEmit app/api/intake/next-question/route.ts` compiles.
Test with curl: `curl -X POST http://localhost:3000/api/intake/next-question -H 'Content-Type: application/json' -d '{"answeredQuestionIds":[],"answers":[],"questionCount":0}'` returns a question object within 2 seconds.
  </verify>
  <done>
AI question selection route works with Claude Haiku, returns next question from curated pool based on prior answers. Deterministic priority-based fallback activates if AI exceeds 1.5s or API key is missing. Response time consistently under 2 seconds per WORK-09.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build intake UI components and wire into page state machine</name>
  <files>
    components/intake/intake-container.tsx
    components/intake/question-card.tsx
    components/intake/smart-input.tsx
    components/intake/intake-progress.tsx
    app/(marketing)/work-with-me/work-with-me-client.tsx
  </files>
  <action>
Create `components/intake/intake-progress.tsx`:
- 'use client'
- Props: currentQuestion (number), totalEstimate (number), minReached (boolean), onGeneratePlan (callback), onContinue (callback)
- When minReached=false: standard progress bar showing currentQuestion/totalEstimate with percentage
- When minReached=true: transform to dual-CTA mode showing "Your plan is ready to generate" with two buttons:
  - Primary: "Generate My Plan" (calls onGeneratePlan)
  - Secondary subtle: "Answer 5 more for better accuracy (+50%)" or "Keep going for a more precise plan" (calls onContinue)
- Progress bar fills to ~60-70% when minimum reached, then grows slightly with each additional answer
- Smooth Framer Motion transitions between states
- Responsive: compact on mobile, full-width on desktop

Create `components/intake/smart-input.tsx`:
- 'use client'
- Props: type ('buttons' | 'text' | 'slider' | 'multi-select'), options (string[]), sliderConfig, value (string), onChange (callback), onSubmit (callback — enter key or button click)
- For 'buttons': render option buttons in a flex-wrap grid. Clicking an option selects it AND auto-advances (calls onSubmit). Selected state with accent color.
- For 'text': render a textarea (2-3 rows) with "Press Enter to continue" hint. Enter submits (shift+enter for newline). Auto-focus on mount.
- For 'slider': render a range input with min/max labels and current value display. Has a "Next" button to confirm.
- For 'multi-select': render option chips that toggle on/off. Has a "Continue" button to confirm selection. Minimum 1 selection required.
- All inputs use project design tokens (border-border, bg-surface, text-foreground, etc.)
- Framer Motion entrance animation (fadeIn)

Create `components/intake/question-card.tsx`:
- 'use client'
- Props: question (IntakeQuestion from lib/data), currentAnswer (string), onAnswer (callback), isLoading (boolean)
- Renders question text as a large, centered heading (text-2xl font-medium)
- Below: SmartInput component configured from question's inputType, options, sliderConfig
- Framer Motion AnimatePresence for question transitions (slide + fade)
- When isLoading=true, show a subtle pulsing indicator (Claude's discretion: typing dots or subtle loading bar) to signal AI is selecting the next question

Create `components/intake/intake-container.tsx`:
- 'use client'
- Props: onComplete (callback receiving answers array), onBack (callback to return to landing)
- Internal state with useReducer:
  - answers: Array of { questionId, questionText, answerValue, answerDisplay, sequenceOrder }
  - currentQuestion: IntakeQuestion | null
  - isLoading: boolean (waiting for AI to select next question)
  - questionCount: number
  - minReached: boolean (questionCount >= MIN_QUESTIONS)
- Flow:
  1. On mount, fetch first question from /api/intake/next-question with empty history
  2. Display question via QuestionCard
  3. On answer: store answer in state, increment count, check if minReached
  4. If not minReached: immediately fetch next question
  5. If minReached: show IntakeProgress with dual CTA
  6. If "Continue": fetch next question (now including deep-dive pool)
  7. If "Generate Plan": call onComplete with all answers
- Back button: navigate to previous question, remove last answer from state, re-display that question with its previous answer pre-filled
- Skip link: submit empty answer ("Skipped") and fetch next question
- "Back to services" link at the top to return to landing (calls onBack)
- Save answers to sessionStorage after each question for session recovery
- Responsive layout: question centered vertically with max-w-2xl

Update `app/(marketing)/work-with-me/work-with-me-client.tsx`:
- Replace intake stage placeholder with `<IntakeContainer onComplete={(answers) => { setAnswers(answers); setStage('generating'); }} onBack={() => setStage('landing')} />`
- Add `answers` to component state: `useState<IntakeAnswer[]>([])`
- Import IntakeContainer from '@/components/intake/intake-container'
  </action>
  <verify>
All component files exist and export their named components.
`npx tsc --noEmit` passes for all new/modified files.
Navigate to /work-with-me, click CTA, see first question appear with smart input.
Answer 6+ questions, see "Generate plan" option appear.
Back button navigates to previous question with pre-filled answer.
Skip link advances to next question.
Question transitions have smooth animation.
  </verify>
  <done>
Full intake UI working: one-question-at-a-time display with AI-selected questions, smart inputs (buttons/text/slider/multi-select), adaptive progress bar with generate-plan/continue-for-accuracy choice after minimum questions, back navigation with answer preservation, skip option, session storage backup. Integrated into /work-with-me page state machine.
  </done>
</task>

</tasks>

<verification>
- /work-with-me CTA triggers smooth transition to intake
- First question appears within 2 seconds of starting
- Each subsequent question appears within 2 seconds of answering
- Smart inputs render correctly for each question type
- Back button works and preserves previous answers
- Skip link advances without requiring an answer
- After 6-8 questions, "Generate My Plan" option appears alongside "Answer more"
- After minimum, clicking "Generate My Plan" transitions to generating stage
- AI never invents questions not in the library
- Deterministic fallback works when AI is slow or unavailable
</verification>

<success_criteria>
A visitor can start the intake, answer questions one at a time with appropriate input types, navigate back to change answers, skip questions, and choose when to generate their plan after reaching the minimum question threshold. Question selection feels intelligent and fast (< 2s latency). The experience feels like a Typeform survey, not a traditional form.
</success_criteria>

<output>
After completion, create `.planning/phases/03-consulting-funnel/03-03-SUMMARY.md`
</output>

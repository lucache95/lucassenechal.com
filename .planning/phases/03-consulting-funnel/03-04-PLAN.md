---
phase: 03-consulting-funnel
plan: 04
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - app/api/intake/generate-plan/route.ts
  - components/intake/plan-display.tsx
  - components/pdf/business-plan-pdf.tsx
autonomous: true
requirements: [WORK-06]

must_haves:
  truths:
    - "Business plan streams section-by-section in real-time as AI generates it"
    - "Plan includes all WORK-06 sections: goal mirroring, bottleneck diagnosis, system steps, tools, phases, risks, estimate + timeline, next steps"
    - "Plan uses paraphrased mirroring — restates client situation in cleaner language, not direct quotes"
    - "Estimate includes detailed phase-by-phase breakdown with timeline (not just S/M/L tiers)"
    - "Downloadable PDF available via 'Download your plan' button after generation completes"
  artifacts:
    - path: "app/api/intake/generate-plan/route.ts"
      provides: "Streaming business plan generation Route Handler using Claude Sonnet"
      exports: ["POST"]
    - path: "components/intake/plan-display.tsx"
      provides: "Streaming plan display with progressive section rendering"
      contains: "PlanDisplay"
    - path: "components/pdf/business-plan-pdf.tsx"
      provides: "React-PDF template for downloadable business plan"
      contains: "BusinessPlanPDF"
  key_links:
    - from: "components/intake/plan-display.tsx"
      to: "app/api/intake/generate-plan/route.ts"
      via: "useObject hook streaming structured plan data"
      pattern: "useObject.*api/intake/generate-plan"
    - from: "app/api/intake/generate-plan/route.ts"
      to: "lib/schemas/business-plan.ts"
      via: "Output.object schema for structured streaming"
      pattern: "businessPlanSchema"
    - from: "components/pdf/business-plan-pdf.tsx"
      to: "lib/schemas/business-plan.ts"
      via: "BusinessPlan type for PDF template props"
      pattern: "BusinessPlan"
---

<objective>
Build the AI business plan generation pipeline: a streaming API route that produces structured plan output using Claude Sonnet, a real-time display component that renders sections as they arrive, and a downloadable PDF template.

Purpose: The instant business plan is the conversion hook. A prospective client answers questions and immediately receives a detailed, personalized analysis of their business — demonstrating competence and value before any sales conversation. Streaming reduces perceived wait time by showing results progressively.

Output: Working plan generation API, streaming display component, and PDF download capability.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-consulting-funnel/03-RESEARCH.md
@.planning/phases/03-consulting-funnel/03-01-SUMMARY.md
@lib/schemas/business-plan.ts
@lib/data/services.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create streaming business plan generation API route</name>
  <files>
    app/api/intake/generate-plan/route.ts
  </files>
  <action>
Create `app/api/intake/generate-plan/route.ts`:

- Set `export const maxDuration = 60;` at top (plan generation may take 15-30 seconds)
- Import `streamText`, `Output` from 'ai' (v6 pattern — NOT streamObject standalone)
- Import `anthropic` from '@ai-sdk/anthropic'
- Import `businessPlanSchema` from '@/lib/schemas/business-plan'
- Import `SERVICES` from '@/lib/data/services'

POST handler:
1. Parse request body: `{ answers: { questionId: string, questionText: string, answerValue: string }[] }`
2. Format answers into a readable summary for the AI prompt
3. Call `streamText` with:
   - model: `anthropic('claude-sonnet-4-20250514')` — quality model for plan generation
   - output: `Output.object({ schema: businessPlanSchema })`
   - system prompt: Detailed consulting prompt that includes:
     - "You are an expert AI systems consultant (Lucas Senechal) generating a detailed 1-page business plan for a prospective client."
     - "Based on their intake answers, produce a comprehensive plan that demonstrates deep understanding of their situation."
     - "CRITICAL: Paraphrase their situation in cleaner language. Do NOT quote their answers directly."
     - "The estimate should include a realistic cost range and timeline with specific phases (MVP, Hardening, Reporting)."
     - "Be specific about tools and integrations — mention real products (Zapier, Make, Supabase, Claude API, etc.) based on their stack and needs."
     - "Recommend exactly ONE of these services: ai-automation, process-consulting, ongoing-management, training"
     - Include the 4 service descriptions from SERVICES for context
   - prompt: The formatted intake answers
4. Return `result.toTextStreamResponse()` for streaming

Error handling:
- If ANTHROPIC_API_KEY is not set, return 500 with message
- Wrap in try/catch, return 500 on generation errors
  </action>
  <verify>
`npx tsc --noEmit app/api/intake/generate-plan/route.ts` compiles.
Test with curl (will take 15-30s): `curl -X POST http://localhost:3000/api/intake/generate-plan -H 'Content-Type: application/json' -d '{"answers":[{"questionId":"business-type","questionText":"What does your business do?","answerValue":"Real estate agency with 20 agents"},{"questionId":"team-size","questionText":"How big is your team?","answerValue":"6-20"},{"questionId":"pain","questionText":"Biggest bottleneck?","answerValue":"Manual follow-ups after showings"}]}'` returns streaming JSON chunks.
  </verify>
  <done>
Streaming business plan API route works with Claude Sonnet, generates structured plan matching all WORK-06 sections, streams response for progressive client-side rendering. Paraphrased mirroring, specific tool recommendations, and realistic estimates with phase breakdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build plan display component and PDF template</name>
  <files>
    components/intake/plan-display.tsx
    components/pdf/business-plan-pdf.tsx
  </files>
  <action>
Create `components/intake/plan-display.tsx`:
- 'use client'
- Import `experimental_useObject as useObject` from '@ai-sdk/react' (v6 import path)
- Import `businessPlanSchema`, `BusinessPlan` from '@/lib/schemas/business-plan'
- Props: answers (array of intake answers), onBookCall (callback), onNewAssessment (callback)
- Use `useObject` hook with:
  - api: '/api/intake/generate-plan'
  - schema: businessPlanSchema
- On mount (useEffect), call `submit({ answers })` to trigger plan generation
- Render plan sections progressively as they stream in:
  - Each section wrapped in a motion.div with fadeIn animation (appears when data arrives)
  - Section order matching WORK-06: Goal Mirroring -> Bottleneck Diagnosis -> Proposed System Steps -> Tools & Integrations -> Implementation Phases -> Risks & Dependencies -> Estimate & Timeline -> Next Steps
  - Goal Mirroring: blockquote-style with emphasis
  - Bottleneck Diagnosis: highlighted card
  - System Steps: numbered list with optional tool badges
  - Implementation Phases: timeline-style cards (MVP -> Hardening -> Reporting) with duration and deliverables
  - Estimate: prominent card with cost range, timeline, and assumptions list
  - Recommended Service: subtle badge showing which service fits
  - Next Steps: checklist-style with "Book a discovery call" as the primary action
- While loading (before first data): show a skeleton/shimmer state with plan section placeholders
- Loading message: "Analyzing your answers and building your custom plan..." with subtle animation
- After generation completes (isLoading=false):
  - Show "Download your plan" button (triggers PDF generation)
  - Show "Book a Discovery Call" CTA button (calls onBookCall)
  - Show subtle "Start a new assessment" link at the bottom (calls onNewAssessment)
- PDF download button: use dynamic import for BusinessPlanPDF with ssr: false. On click, generate and download PDF.
- Responsive: max-w-3xl centered, card-based sections with proper spacing

Create `components/pdf/business-plan-pdf.tsx`:
- 'use client' directive (PDF library requires client-side rendering)
- Import from '@react-pdf/renderer': Document, Page, Text, View, StyleSheet, PDFDownloadLink
- Import `BusinessPlan` type from '@/lib/schemas/business-plan'
- Props: plan (BusinessPlan), clientName (string)
- Create a professional 1-page PDF layout:
  - Header: "Business Plan for [clientName]" + "Prepared by Lucas Senechal" + date
  - Sections matching the on-page display order
  - Clean typography: serif for headings, sans-serif for body
  - Blue accent color matching site palette
  - Footer: "lucassenechal.com | AI Systems Consulting"
- Export `BusinessPlanPDF` component (the Document)
- Export `PlanDownloadButton` component that wraps PDFDownloadLink with a styled button
- Use dynamic import with `ssr: false` in the consuming component to avoid SSR crashes (per research pitfall #5)
  </action>
  <verify>
`npx tsc --noEmit` passes for both files.
Plan display renders streaming sections progressively (verify with dev tools network tab showing chunked response).
After generation completes, "Download your plan" button appears.
Clicking download generates a PDF file (verify it opens and has content).
"Book a Discovery Call" and "Start a new assessment" buttons are visible.
  </verify>
  <done>
Plan display streams sections in real-time with progressive rendering and skeleton loading state. All WORK-06 sections rendered with appropriate visual treatment. PDF download generates a professional 1-page business plan document. Post-generation CTAs for booking and new assessment are prominently displayed.
  </done>
</task>

</tasks>

<verification>
- Plan generation API streams structured JSON matching businessPlanSchema
- Plan display renders sections progressively as they arrive
- All 9 WORK-06 sections appear in the generated plan
- Estimate includes phase-by-phase breakdown with timeline (not just S/M/L)
- Goal mirroring paraphrases, does not quote directly
- PDF download produces a readable document
- Loading state shows meaningful feedback while generating
- "Book a Discovery Call" and "Start a new assessment" CTAs visible after generation
</verification>

<success_criteria>
A visitor who completes the intake sees their business plan streaming in section-by-section within seconds. The plan demonstrates deep understanding of their situation with specific tool recommendations and realistic estimates. They can download it as a PDF and proceed to book a call. The experience feels premium and personalized.
</success_criteria>

<output>
After completion, create `.planning/phases/03-consulting-funnel/03-04-SUMMARY.md`
</output>

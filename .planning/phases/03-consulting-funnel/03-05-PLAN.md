---
phase: 03-consulting-funnel
plan: 05
type: execute
wave: 3
depends_on: [03-02, 03-03, 03-04]
files_modified:
  - components/intake/lead-capture-gate.tsx
  - components/consulting/cal-embed.tsx
  - app/actions/intake.ts
  - lib/email/intake-notification.tsx
  - app/(marketing)/work-with-me/work-with-me-client.tsx
autonomous: false
requirements: [WORK-07, WORK-08, WORK-09, WORK-10, WORK-11, COPY-03]

must_haves:
  truths:
    - "Email + name are captured before plan generation (lead capture gate)"
    - "All intake data (answers, plan, timestamps) is stored in Supabase even if visitor doesn't book"
    - "Cal.com booking embed is displayed after viewing the plan"
    - "Urgency messaging shows manually-updated spot count near booking CTA"
    - "Email notification is sent to Lucas when someone completes an intake"
    - "After booking: thank you confirmation with optional 'answer more for better accuracy' pitch"
    - "Full funnel flow works end-to-end: landing -> intake -> lead capture -> plan -> booking -> complete"
  artifacts:
    - path: "components/intake/lead-capture-gate.tsx"
      provides: "Email + name capture form displayed before plan generation"
      contains: "LeadCaptureGate"
    - path: "components/consulting/cal-embed.tsx"
      provides: "Cal.com booking embed wrapper"
      contains: "CalEmbed"
    - path: "app/actions/intake.ts"
      provides: "Server Actions for persisting intake data and sending notification"
      contains: "saveIntakeSession"
    - path: "lib/email/intake-notification.tsx"
      provides: "React Email template notifying Lucas of new lead"
      contains: "IntakeNotificationEmail"
    - path: "app/(marketing)/work-with-me/work-with-me-client.tsx"
      provides: "Complete funnel state machine wiring all stages together"
      contains: "FunnelStage"
  key_links:
    - from: "app/(marketing)/work-with-me/work-with-me-client.tsx"
      to: "app/actions/intake.ts"
      via: "Server Action called to save session data before/after plan generation"
      pattern: "saveIntakeSession"
    - from: "app/actions/intake.ts"
      to: "lib/supabase/server.ts"
      via: "Supabase service_role client for data persistence"
      pattern: "createClient"
    - from: "app/actions/intake.ts"
      to: "lib/email/intake-notification.tsx"
      via: "Resend sends notification email to Lucas"
      pattern: "resend.emails.send"
    - from: "components/consulting/cal-embed.tsx"
      to: "cal.com"
      via: "Vanilla JS embed script loaded via Next.js Script component"
      pattern: "cal.com/embed/embed.js"
    - from: "components/intake/lead-capture-gate.tsx"
      to: "app/(marketing)/work-with-me/work-with-me-client.tsx"
      via: "onSubmit callback passing email + name to parent state"
      pattern: "onSubmit.*email.*name"
---

<objective>
Wire the complete consulting funnel end-to-end: lead capture gate before plan generation, Supabase data persistence for all intake data, Cal.com booking embed, email notification to Lucas, urgency messaging, and the post-booking thank-you flow. Connect all stages of the page state machine into a cohesive conversion funnel.

Purpose: This plan completes the revenue-generating consulting funnel. Lead capture ensures no prospect is lost even if they don't book. Data persistence gives Lucas context before every call. The booking embed removes friction from scheduling. Email notifications enable fast follow-up.

Output: Complete end-to-end consulting funnel from first CTA click to booking confirmation.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-consulting-funnel/03-CONTEXT.md
@.planning/phases/03-consulting-funnel/03-RESEARCH.md
@.planning/phases/03-consulting-funnel/03-02-SUMMARY.md
@.planning/phases/03-consulting-funnel/03-03-SUMMARY.md
@.planning/phases/03-consulting-funnel/03-04-SUMMARY.md
@app/(marketing)/work-with-me/work-with-me-client.tsx
@app/actions.ts
@lib/supabase/server.ts
@lib/email/welcome-template.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lead capture gate, Cal.com embed, and notification email</name>
  <files>
    components/intake/lead-capture-gate.tsx
    components/consulting/cal-embed.tsx
    lib/email/intake-notification.tsx
  </files>
  <action>
Create `components/intake/lead-capture-gate.tsx`:
- 'use client'
- Props: onSubmit (callback receiving { email: string, name: string })
- Simple, clean form: two inputs (name, email) and a submit button
- Headline: "One last thing before your plan" or similar warm phrasing
- Subtext: "We'll email you a copy and prepare for your call"
- Name input: text, required, placeholder "Your name"
- Email input: email, required, placeholder "your@email.com"
- Client-side validation: name min 1 char, email format check
- Submit button: "Generate My Plan" (primary accent style)
- Framer Motion fadeIn animation
- Centered layout matching intake question style (max-w-md)
- On submit: call onSubmit with { email, name }

Create `components/consulting/cal-embed.tsx`:
- 'use client'
- Import Script from 'next/script' (NOT @calcom/embed-react — React 19 conflict)
- Props: spotCount (number), spotMonth (string)
- Load Cal.com embed via vanilla JS script: `https://app.cal.com/embed/embed.js`
- On script load, initialize Cal inline embed:
  ```
  Cal("init", { origin: "https://cal.com" });
  Cal("inline", {
    elementOrSelector: "#cal-embed",
    calLink: "lucas-senechal",
    layout: "month_view",
  });
  ```
- Render container div with id="cal-embed" and min-height: 500px
- Above the embed: heading "Book Your Discovery Call" with subtext "15 minutes, no obligation. Let's see if we're a fit."
- Urgency badge: "{spotCount} spots left for {spotMonth}" using the props (sourced from env vars)
- Below embed: "All your intake data will be ready for our call" reassurance text
- Framer Motion entrance animation

Create `lib/email/intake-notification.tsx`:
- Follow existing pattern from `lib/email/welcome-template.tsx`
- Import from '@react-email/components': Html, Head, Body, Container, Heading, Text, Section, Hr, Link
- Props: name (string), email (string), businessDescription (string), recommendedService (string), questionCount (number), planSummary (string — first 200 chars of goal mirroring)
- Email subject (exported separately): "New Consulting Lead: {name} — {recommendedService}"
- Body: Clean notification layout with:
  - "New consulting lead just completed intake"
  - Name + email
  - Business description (answer to first question)
  - Recommended service
  - Number of questions answered
  - Plan summary (truncated goal mirroring)
  - Quick link to reply to the lead's email
- Inline styles matching project email template pattern
  </action>
  <verify>
All 3 component files exist and export named components.
`npx tsc --noEmit` passes for all files.
Cal.com embed script URL is correct (https://app.cal.com/embed/embed.js).
Email template renders without errors.
  </verify>
  <done>
Lead capture gate collects name + email before plan generation. Cal.com booking embed loads via vanilla JS (avoiding React 19 conflict) with urgency messaging. Notification email template ready to alert Lucas of new leads.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Server Action for data persistence and wire complete funnel</name>
  <files>
    app/actions/intake.ts
    app/(marketing)/work-with-me/work-with-me-client.tsx
  </files>
  <action>
Create `app/actions/intake.ts`:
- 'use server' directive
- Import createClient from '@/lib/supabase/server' (async server client with service_role)
- Import Resend and IntakeNotificationEmail
- Import render from '@react-email/render'

Export `saveIntakeSession` Server Action:
1. Accepts: { email: string, name: string, answers: IntakeAnswer[] }
2. Creates intake_sessions row with email, name, status='in_progress'
3. Bulk inserts all answers into intake_answers with session_id
4. Returns { sessionId: string } for subsequent plan storage
5. Uses service_role Supabase client (matching project pattern from app/actions.ts)

Export `saveIntakePlan` Server Action:
1. Accepts: { sessionId: string, plan: BusinessPlan }
2. Inserts plan_json and recommended_service into intake_plans
3. Updates intake_sessions status to 'plan_generated', sets plan_generated_at
4. Fire-and-forget email notification to Lucas: resend.emails.send() with IntakeNotificationEmail, .catch(console.error) without await (matching project pattern)
5. Send to Lucas's email (from env or hardcoded — RESEND_FROM_EMAIL or similar)
6. Returns { success: true }

Export `markIntakeBooked` Server Action:
1. Accepts: { sessionId: string }
2. Updates intake_sessions status to 'booked', sets booked_at
3. Returns { success: true }

Update `app/(marketing)/work-with-me/work-with-me-client.tsx` to wire the complete funnel:
- Add state: leadInfo ({ email, name } | null), sessionId (string | null), generatedPlan (BusinessPlan | null)
- Read env vars for spots: process.env.NEXT_PUBLIC_CAL_SPOTS_REMAINING, process.env.NEXT_PUBLIC_CAL_SPOTS_MONTH

Complete stage flow:
1. **landing**: ConsultingHero + ServiceGrid + HowItWorks + TrustStrip + FAQ + Footer. CTA -> 'intake'
2. **intake**: IntakeContainer. onComplete(answers) -> store answers, transition to 'capture'
3. **capture** (NEW stage): LeadCaptureGate. onSubmit({ email, name }) -> store leadInfo, call saveIntakeSession Server Action to persist answers, store sessionId, transition to 'generating'
4. **generating/plan**: PlanDisplay with answers. The PlanDisplay now receives sessionId and leadInfo. When plan generation completes internally, PlanDisplay calls saveIntakePlan Server Action. Shows streaming plan + after completion: "Download your plan" button, "Book a Discovery Call" button. CTA onBookCall -> 'booking'. Also show onNewAssessment link.
5. **booking**: Cal.com embed with urgency messaging. After interaction (or skip), show "Complete" button. Optionally: "Answer a few more questions to help me prepare" pitch linking back to intake with deep-dive questions. CTA -> 'complete'. When transitioning to complete, call markIntakeBooked.
6. **complete**: Thank you message. "Your plan has been saved. I'll review your answers before our call." + link to /newsletter for cross-pollination + "Start a new assessment" link.

- AnimatePresence mode="wait" wrapping all stages
- Scroll to top on stage change
- Error handling: if Server Action fails, show toast/alert but don't block the flow
  </action>
  <verify>
Complete end-to-end flow test:
1. Navigate to /work-with-me — see landing page
2. Click CTA — transition to intake
3. Answer 6+ questions — see "Generate plan" option
4. Click "Generate My Plan" — see lead capture form
5. Enter name + email, submit — transition to plan generation
6. See plan streaming in — all sections render
7. After plan completes — see Download + Book buttons
8. Click "Book a Discovery Call" — see Cal.com embed with urgency
9. Complete booking — see thank you page

Verify Supabase (if migration has been run):
- intake_sessions has a row with email, name, status
- intake_answers has rows for each answer
- intake_plans has the generated plan JSON

Verify email (if Resend is configured):
- Lucas receives notification email with lead details
  </verify>
  <done>
Complete consulting funnel working end-to-end. Lead capture gate collects name/email before plan generation. All intake data persisted to Supabase (session, answers, plan). Email notification sent to Lucas on intake completion. Cal.com booking embed with urgency messaging. Post-booking thank you with cross-pollination to newsletter. Full state machine: landing -> intake -> capture -> plan -> booking -> complete.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete consulting funnel end-to-end</name>
  <files>app/(marketing)/work-with-me/page.tsx</files>
  <action>
CHECKPOINT: Human verifies the complete consulting funnel at /work-with-me.

What was built:
- Consulting landing page with hero, service cards, how-it-works, FAQ, trust strip
- AI-powered smart intake with one question at a time, smart inputs, progress tracking
- Lead capture (email + name) before plan generation
- Streaming business plan with all sections (goal mirroring, bottleneck, system steps, tools, phases, risks, estimate, next steps)
- PDF download of the business plan
- Cal.com booking embed with urgency messaging
- Supabase data persistence for all intake data
- Email notification to Lucas on intake completion
  </action>
  <verify>
1. Visit http://localhost:3000/work-with-me
2. Verify: Hero section has compelling F/G/E copy, 4 service cards in grid, 3-step how-it-works, FAQ with expand/collapse, trust strip logos, no pricing anywhere
3. Click the main CTA button
4. Verify: First question appears within 2 seconds, centered Typeform-style
5. Answer 6+ questions, testing different input types (text, buttons, slider)
6. Test: Click back button to change a previous answer
7. Test: Use skip link on one question
8. After 6-8 questions, verify: "Generate My Plan" option appears alongside "Answer more for accuracy"
9. Click "Generate My Plan"
10. Verify: Lead capture form asks for name + email
11. Enter details and submit
12. Verify: Business plan streams in section by section — all WORK-06 sections present
13. Verify: Estimate shows phase-by-phase breakdown with timeline
14. After generation: verify "Download your plan" and "Book a Discovery Call" buttons
15. Click download — verify PDF generates and opens
16. Click "Book a Discovery Call" — verify Cal.com embed loads
17. Verify: Urgency messaging shows spot count
18. Overall: page is responsive, animations are smooth, tone is professional

Type "approved" if the funnel works end-to-end, or describe any issues.
  </verify>
  <done>User has verified the complete consulting funnel works end-to-end: landing page, intake, lead capture, plan generation, PDF download, booking, and data persistence. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
- Full funnel flow: landing -> intake -> capture -> plan -> booking -> complete
- Lead capture before plan generation (WORK-08)
- All intake data persisted to Supabase (WORK-08)
- Cal.com booking embed working (WORK-07)
- Email notification sent to Lucas on completion
- Urgency messaging near booking CTA
- Responsive and smooth animations throughout
- No pricing displayed anywhere
- F/G/E copy framework applied consistently (COPY-03)
</verification>

<success_criteria>
A prospective client can visit /work-with-me, understand the services, start the AI intake, answer questions, provide their contact info, receive a streaming personalized business plan, download it as PDF, and book a discovery call — all on one page with smooth transitions. Lucas receives an email notification with lead context. All data is persisted for call preparation.
</success_criteria>

<output>
After completion, create `.planning/phases/03-consulting-funnel/03-05-SUMMARY.md`
</output>
